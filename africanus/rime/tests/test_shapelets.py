import numpy as np
import pytest
import matplotlib.pyplot as plt

def test_shapelets():
    from africanus.rime import shapelet_dde
    npix = 83
    nsrc = npix ** 2
    ntime = 1
    na = 1
    nchan = 1
    npoly = 3
    
    test_data = np.load("./fourier_shapelet.npy")
    
    
    b = np.array([2.5, 6.0])
    c = np.fft.fft(np.array([ 1.99881891e+00, -2.77027685e-01,  2.44012755e+00, -3.90623524e-01,
         8.92007694e-01, -7.58891195e-02, -5.67971136e-01,  4.96400520e-01,
         1.60286952e-01, -6.67729822e-02,  3.95983865e-01,  1.14637076e-01,
        -9.66586357e-02,  2.04052859e-01,  1.21659519e-01, -5.40919313e-02,
        -2.71946441e-02,  7.24469969e-02, -1.21360524e-01,  4.12995224e-02,
        -1.23427062e-01, -6.87210459e-02,  3.48628725e-03, -6.31312466e-02,
        -3.21526535e-02, -2.83520549e-02, -8.67405946e-02, -7.09417085e-02,
        -4.52094167e-02, -4.90309136e-02, -4.41691296e-02, -2.60611416e-02,
        -1.90851457e-01,  4.68895929e-02, -2.15221957e-01,  6.84835444e-02,
        -5.14444297e-02,  3.41214378e-02,  8.84866441e-02, -1.67729062e-02,
         2.34292977e-02,  6.39233536e-02,  1.32957761e-02,  5.30078158e-02,
         6.73949945e-02,  4.18037655e-02,  4.50595223e-02,  6.16033419e-02,
        -1.20467832e-03, -1.19580608e-02,  8.29755624e-03, -1.41320969e-02,
         1.63444684e-02,  3.02491045e-03, -8.15248801e-03, -4.94898547e-03,
        -1.35385618e-02, -1.63421267e-02, -9.95599427e-03, -1.35840938e-02,
        -2.12634674e-02, -2.08479258e-02, -2.27691848e-02, -2.74610235e-02,
         3.41431730e-02,  3.38049231e-03,  2.96927393e-02,  3.25353101e-03,
         1.87499391e-02,  8.23253664e-03,  4.86960654e-03,  2.03616138e-02,
         1.72620503e-02,  1.70993405e-02,  2.20117477e-02,  2.08312459e-02,
         1.78612480e-02,  2.62116592e-02,  2.43488650e-02,  2.95665953e-02,
        -3.78991756e-03,  2.61031882e-03, -7.25095611e-03, -2.49510975e-03,
        -4.93818611e-03, -3.82278513e-03, -3.61304245e-03, -7.62019811e-03,
        -6.28757404e-03, -4.40547508e-03, -6.44758165e-03, -6.16425209e-03,
        -7.34008045e-03, -1.13525740e-02, -1.09914868e-02, -1.66498281e-02,
         8.28389931e-03,  8.70953277e-03, -2.57579683e-03,  1.01081468e-02,
         9.03729582e-03,  1.14149511e-02,  1.22368364e-02,  1.19779478e-02,
         1.69044097e-02,  1.40624538e-02,  1.63861626e-02,  1.51975563e-02,
         1.61390707e-02,  1.80248150e-02,  1.52490094e-02,  2.28706621e-02,
        -2.67263409e-03, -1.74584966e-03, -2.20901402e-03, -5.89443275e-03,
        -2.62289741e-03, -2.45603656e-03, -5.70156710e-03, -6.27808906e-03,
        -5.46835295e-03, -3.25367099e-03, -3.57354906e-03, -3.36863470e-03,
        -5.40383137e-03, -8.94799163e-03, -6.71881137e-03, -1.19917016e-02,
         1.17130368e-02,  1.00273321e-02,  1.93771350e-03,  9.77251996e-03,
         9.22609155e-03,  9.97910653e-03,  1.01018824e-02,  1.08673119e-02,
         1.65281900e-02,  1.20974856e-02,  1.54193521e-02,  1.39119463e-02,
         1.39577919e-02,  1.63231099e-02,  1.15638315e-02,  1.79372691e-02,
        -3.05604886e-03, -2.79673701e-03, -3.35563287e-03, -6.04766673e-03,
        -3.59963679e-03, -2.98395830e-03, -6.46530016e-03, -7.94032414e-03,
        -6.10488189e-03, -4.40232294e-03, -4.05876456e-03, -2.89877183e-03,
        -4.40182031e-03, -7.29474234e-03, -4.26583325e-03, -8.19149963e-03,
         9.45610610e-03,  1.12060194e-02,  2.23375329e-03,  9.93522592e-03,
         7.08442737e-03,  9.37256522e-03,  1.03864905e-02,  1.03151998e-02,
         1.59787082e-02,  1.23245411e-02,  1.32637533e-02,  1.29577576e-02,
         1.10701293e-02,  1.36368636e-02,  8.40219360e-03,  1.34514234e-02,
        -3.36801022e-03, -3.70907789e-03, -4.94237872e-03, -5.59019395e-03,
        -3.58711314e-03, -3.26114691e-03, -6.81657596e-03, -9.54647393e-03,
        -6.20998704e-03, -5.76799792e-03, -4.17243967e-03, -2.57755100e-03,
        -3.57334001e-03, -5.99687724e-03, -2.69773785e-03, -5.45597189e-03,
         7.77997878e-03,  1.07213272e-02,  2.66177607e-03,  9.12556194e-03,
         4.85944395e-03,  8.83227727e-03,  1.04674528e-02,  9.71567444e-03,
         1.48440780e-02,  1.23421420e-02,  1.08564816e-02,  1.17386345e-02,
         8.01602532e-03,  1.08446806e-02,  6.27814904e-03,  1.01501022e-02,
        -3.47794040e-03, -4.20472576e-03, -6.55344954e-03, -4.23397354e-03,
        -3.16947530e-03, -3.07756861e-03, -6.22175574e-03, -1.01166617e-02,
        -5.21004644e-03, -6.15487184e-03, -3.93855774e-03, -2.39647546e-03,
        -3.03484352e-03, -5.47442613e-03, -2.12225305e-03, -4.26763707e-03,
         6.71773998e-03,  8.99313004e-03,  2.37891770e-03,  7.85280324e-03,
         3.19750145e-03,  8.46681156e-03,  1.02297805e-02,  8.50017093e-03,
         1.33059408e-02,  1.18630098e-02,  9.08458723e-03,  1.08425227e-02,
         6.07690658e-03,  8.85722840e-03,  5.27947042e-03,  8.19897363e-03,
        -3.33311101e-03, -4.69403999e-03, -7.55868727e-03, -2.49738562e-03,
        -2.37453225e-03, -2.62593164e-03, -5.09719540e-03, -9.60465475e-03,
        -3.59636160e-03, -5.70513152e-03, -3.71263835e-03, -2.50198813e-03,
        -3.06395965e-03, -5.62212111e-03, -2.31326245e-03, -4.16535832e-03]))
    nmax = [16,16]
    xc = [52.0, 49.0]
    ry=np.array(range(0,npix),dtype=float)-xc[0]
    rx=np.array(range(0,npix),dtype=float)-xc[1]
    
   
    lm = np.array(np.meshgrid(rx,ry)).T.reshape(nsrc, 2)
    lm = (np.reshape(np.tile(rx,len(ry)),(len(ry)*len(rx))), np.reshape(np.tile(ry,len(rx)),(len(rx)*len(ry))).T)
    
    #print(lm.shape)
    

    coords = np.empty((2, nsrc, ntime, na, nchan))
    coeffs = np.empty((na, nchan, nmax[0], nmax[1]))    
    beta = np.zeros((na, nchan, 2))
    
    coords[0, :, 0, 0, 0], coords[1, :, 0, 0, 0] = lm[0], lm[1]
    coeffs = c.reshape(coeffs.shape)
    beta[:, :, 0], beta[:, :, 1] = b[0], b[1]
    
    out_shapelets = shapelet_dde(coords, coeffs, beta)[:, 0, 0, 0].reshape((npix,npix))
    
    plt.figure()
    plt.imshow(np.abs(out_shapelets))
    plt.savefig("./out_shapelets.png")
    plt.close()
    
    
    plt.figure()
    plt.imshow(np.abs(test_data))
    plt.savefig("./test_data.png")
    plt.close()
    
    assert np.allclose(out_shapelets, test_data, atol=1e-4, rtol=1e-6)